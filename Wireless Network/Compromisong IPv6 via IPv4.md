# IPv6 Attacks
- **IPv6 Attack Toolkit** : https://github.com/vanhauser-thc/thc-ipv6/
- Windows versions since Windows Vista (including server variants) have IPv6 enabled and prefer it over IPv4.
- Partial Version of [SLAAC](https://resources.infosecinstitute.com/topic/slaac-attack/) attack, which sets up various services to MITM attack in the network by acting as a rouge IPv6 router.
- Downside of **SLAAC** attack attempts to create an IPv6 overlay network over the existing IPv4 network, which **destabilize** the network. 

# The MiTM6 attack
- Download: https://github.com/dirkjanm/mitm6
## Phase 1: Primary DNS Takeover
- Start by Listening on the Primary interface of the attacker for windows clients requesting IPv6 configuration via DHCPv6.
	- `sudo mitm6 -d <domain.local>`
- mitm6 will reply to those DHCPv6 requests, assigning the victim an IPv6 address within the link-local range.
- It automatically detects the IP configuration of the attacker machine and replies to DHCPv6 requests sent by clients in the network with a DHCPv6 reply containing the attacker’s IP as DNS server.
	>  It should be noted that mitm6 currently only targets Windows based operating systems, since other operating systems like macOS and Linux do not use DHCPv6 for DNS server assignment.

## Phase 2: DNS Spoofing
- The attacker server will be configured as DNS server on the Victim machine.
- The IPv6 DNS server will be used to query both for A (IPv4) and AAAA (IPv6) records.
- Next step is to get clients to connect to the attacker machine instead of the legitimate servers.
- Our end goal is getting the user or browser to automatically authenticate to the attacker machine, which is why we are spoofing URLs in the internal domain `domain.local`.

## Exploiting WPAD (Windows Proxy Auto Detection)
- Legitimate use of WPAD is to automatically detect a network proxy used for connecting to the internet in corporate environments.
-  The address of the server providing the *wpad.dat* file would be resolved using DNS, and if no entry was returned, the address would be resolved via insecure broadcast protocols such as Link-Local Multicast Name Resolution (LLMNR).
- An attacker replies to these broadcast name resolution protocols, pretending that the WPAD file was located on their server which prompts for authentication to access the WPAD file.
- This authentication is provided by default by Windows. This provides the attacker with **NTLM credentials** from the user logged in on that computer, which could be used to authenticate to services in a process called **NTLM relaying**.
> In 2016 however, Microsoft published a security bulletin [MS16-077](https://support.microsoft.com/en-us/help/3165191/ms16-077-security-update-for-wpad-june-14--2016), which mitigated this attack by adding two important protections:  
– The location of the WPAD file is no longer requested via broadcast protocols, but only via DNS.  
– Authentication does not occur automatically anymore even if this is requested by the server.

## Exploiting WPAD post MS16-077
- **First Protection Bypass**
	- where WPAD is only requested via DNS, can be easily bypassed with mitm6.
	- As soon as the victim machine sets the IPv6 DNS server of the attacker, it will query for the WPAD configuration of the network to the attacker machine and reply with their own address.
- **Second Protection Bypass**
	- Since the credentials are not provided by default, When the victim requests a WPAD file we won’t request authentication, but instead provide it with a valid WPAD file where the attacker’s machine is set as a proxy.
	- When the victim now runs any application that uses the Windows API to connect to the internet, it will use the attackers machine as a proxy.
	- This works in Edge, Internet Explorer, Firefox and Chrome, since they all respect the WPAD system settings by default.
	- Windows will now send the **NTLM** challenge/response to the attacker, who can relay it to different services.
	- With this **relaying attack**, the attacker can authenticate as the victim on services, access information on websites and shares.
	- With enough privilege, attacker can execute commands on computer and perform privilege escalation and compromise the Domain.

# Full attack process Briefed
- **First start MiTM6**
	-  Which will start replying to DHCPv6 requests and afterwards to DNS queries requesting names in the internal network.
	-  `sudo mitm6 -d <domain.local>`
- **Using ntlmrelayx**
	- Download: https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py
	- It relays via IPv6, serve the WPAD file, automatically detect proxy requests and prompt the victim for the correct authentication.
	- `ntlmrelayx.py -6 -wh <attacker.domain.local> -t smb://<ip> -l /tmp/ -socks -debug`
	> To serve the WPAD file, we need to add to the command prompt is the host is the `-wh` parameter and with it specify the host that the WPAD file resides on. Since mitm6 gives us control over the DNS, any non-existing hostname in the victim network will do. To make sure ntlmrelayx listens on both IPv4 and IPv6, use the `-6` parameter.

# Mitigation
- Disable the **IPv6** if it is not used on your internal network. This will stop Windows clients querying for a DHCPv6 server and make it impossible to take over the DNS server.
- For the **WPAD exploit**, disable the Proxy Auto detection via Group Policy. If the company uses a proxy configuration file internally (PAC file) it is recommended to explicitly configure the PAC url instead of relying on WPAD to detect it automatically.
- To prevent **NTLM relaying** ,disable it entirely and switch to Kerberos.